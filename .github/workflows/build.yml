name: Build

on:
  schedule:
    - cron: "37 8 * * *"

  workflow_dispatch:

jobs:
  # Windows-MSVC
  Windows:
    name: ${{ matrix.icon }} windows (${{matrix.platform}}, ${{matrix.compiler}}-${{matrix.compiler-ver}}, ${{matrix.build-type}})
    runs-on: ${{matrix.runs-on}}
    strategy:
      fail-fast: false
      matrix:
        runs-on: [windows-2025, windows-11-arm]
        sys: [windows]
        icon: ["â¬œ"]
        buildenv: [VS2022]
        compiler: [MSVC]
        mode: ["cxx23"]
        build-type: ["Release", "Debug"]
        target: ["all"]
        cmake-override: ["-Dincplot_USE_LOCAL_PACKAGES=OFF"]
        include:
          - compiler: "MSVC"
            compiler-ver: "19"
          - runs-on: windows-2025
            platform: "x86_64"
          - runs-on: windows-11-arm
            platform: "arm64"

        # Can't use clang-cl on windows-arm?
        # Leaving this be for the time being
        exclude:
          - runs-on: windows-11-arm
            compiler: clang-cl

    steps:
      - name: "ðŸ§° Checkout"
        uses: actions/checkout@v5

      - uses: TheMrMilchmann/setup-msvc-dev@v4
        with:
          arch: ${{matrix.platform}}

      - name: Configure git credentials
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/" |
          git lfs install
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Configure"
        run: cmake --preset Win_${{matrix.compiler}}_${{matrix.build-type}} ${{matrix.cmake-override}}

      - name: "ðŸš§ Build"
        run: cmake --build build --target ${{matrix.target}}

  # Based on https://github.com/msys2/setup-msys2/blob/main/examples/cmake.yml
  Windows-MSYS:
    name: ${{ matrix.icon }} windows (${{matrix.platform}}, ${{matrix.msystem}}, ${{matrix.compiler}}-${{matrix.compiler-ver}}, ${{matrix.build-type}})
    runs-on: ${{matrix.runs-on}}
    strategy:
      fail-fast: false
      matrix:
        runs-on: ["windows-2025"]
        sys: [windows]
        icon: ["ðŸŸ¦"]

        buildenv: [msys2]
        msystem: [ucrt64, clang64]
        build-type: [Release, Debug]
        compiler: [gcc, clang]
        platform: ["x86_64"]
        target: ["all"]
        cmake-override: ["-Dincplot_CPR_USE_SYSTEM_CURL=ON"]
        include:
          - msystem: ucrt64
            compiler: gcc
            compiler-ver: 15
            add-to-pacboy: ""

          - msystem: ucrt64
            compiler: clang
            compiler-ver: 21
            add-to-pacboy: "clang:p"

          - msystem: clang64
            compiler: clang
            compiler-ver: 21
            add-to-pacboy: ""

        exclude:
          - msystem: clang64
            compiler: gcc

    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: "ðŸ§° Checkout"
        uses: actions/checkout@v5

      - name: "${{ matrix.icon }} Setup MSYS2"
        uses: msys2/setup-msys2@v2.29.0
        with:
          msystem: ${{matrix.msystem}}
          update: true
          install: >-
            git
            make
          pacboy: >-
            toolchain:p
            ${{matrix.add-to-pacboy}}
            ninja:p
            cmake:p
            meson:p

      - name: Configure git credentials
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Configure"
        run: cmake --preset ${{matrix.compiler}}_${{matrix.build-type}} ${{matrix.cmake-override}}

      - name: "ðŸš§ Build"
        run: cmake --build build --target ${{matrix.target}}

  # Based on https://github.com/tcbrindle/flux/blob/main/.github/workflows/linux.yml
  Linux-Ubuntu:
    name: ${{ matrix.icon }} linux (${{matrix.platform}}, ${{matrix.compiler}}-${{matrix.compiler-ver}}, ${{matrix.build-type}})
    runs-on: ${{matrix.runs-on}}
    strategy:
      fail-fast: false
      matrix:
        icon: ["ðŸŸ§"]
        sys: [linux]
        runs-on: [ubuntu-24.04, ubuntu-24.04-arm]
        compiler: [gcc]
        # compiler-ver: [15, 21]
        build-type: [Release, Debug]
        target: ["all"]
        cmake-override: ["-Dincplot_CPR_USE_SYSTEM_CURL=ON"]

        include:
          - runs-on: ubuntu-24.04
            platform: "x86_64"
          - runs-on: ubuntu-24.04-arm
            platform: "arm64"

          - compiler: "gcc"
            compiler-setupname: "gcc"
            compiler-ver: "14"

          # - compiler: "clang"
          #   compiler-setupname: "llvm"
          #   compiler-ver: "21"

    steps:
      - name: "ðŸ§° Checkout"
        uses: actions/checkout@v5

      - name: Setup Cpp
        uses: aminya/setup-cpp@v1
        with:
          setup-cpp: true
          compiler: ${{matrix.compiler-setupname}}-${{matrix.compiler-ver}}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libharfbuzz-dev libfontconfig-dev nlohmann-json3-dev libwoff-dev libxxhash-dev libargparse-dev libarchive-dev libidn2-dev libcurl4-openssl-dev zlib1g-dev

      - name: Configure
        run: |
          cmake --preset ${{matrix.compiler}}_${{matrix.build-type}} ${{matrix.cmake-override}}

      - name: "ðŸš§ Build"
        run: cmake --build build --target ${{matrix.target}}

  macOS:
    name: ${{ matrix.icon }} macos (${{matrix.platform}}, ${{matrix.compiler}}-${{matrix.compiler-ver}}, ${{matrix.build-type}})
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        icon: ["â¬›"]
        sys: [macos]
        runs-on: [macos-26]
        compiler: [clang]
        build-type: ["Release", "Debug"]
        target: ["all"]

        include:
          # - runs-on: macos-15
          #   platform: "arm64"
          # - runs-on: macos-15-intel
          #   platform: "x86_64"
          - runs-on: macos-26
            platform: "arm64"

          # - compiler: "gcc"
          #   compiler-setupname: "gcc"
          #   compiler-ver: "15"
          #   cmake-override: "-DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15"

          - compiler: "clang"
            compiler-setupname: "llvm"
            compiler-ver: "21"
            cmake-override: ""

    steps:
      - name: "ðŸ§° Checkout"
        uses: actions/checkout@v5

      - name: Setup Cpp
        uses: aminya/setup-cpp@v1
        with:
          setup-cpp: true
          compiler: ${{matrix.compiler-setupname}}-${{matrix.compiler-ver}}

      - name: Install dependencies
        run: |
          brew update
          brew install harfbuzz woff2 nlohmann-json xxhash magic_enum argparse indicators cpr

      - name: Configure git credentials
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure
        run: |
          cmake --preset ${{matrix.compiler}}_${{matrix.build-type}}

      - name: "ðŸš§ Build"
        run: cmake --build build --target ${{matrix.target}}
